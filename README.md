<div align="center">

# Wireless KFB GUI

Kompakt Ã¡llomÃ¡salkalmazÃ¡s KFB panelek (MAC) szkennelÃ©sÃ©hez, KSK elÅ‘kÃ©szÃ­tÃ©shez Ã©s CHECK ellenÅ‘rzÃ©sekhez. Next.js App Router + Electron, Redis hÃ¡ttÃ©rtÃ¡rral.

![badge-node](https://img.shields.io/badge/Node-20+-339933?logo=node.js&logoColor=white)
![badge-next](https://img.shields.io/badge/Next.js-15-black?logo=next.js)
![badge-electron](https://img.shields.io/badge/Electron-37-47848F?logo=electron&logoColor=white)
![badge-typescript](https://img.shields.io/badge/TypeScript-5-blue?logo=typescript)
![badge-redis](https://img.shields.io/badge/Redis-required-red?logo=redis&logoColor=white)

</div>

> **NyelvvÃ¡lasztÃ³**  
> ðŸ‡¬ðŸ‡§ Angol dokumentÃ¡ciÃ³: [1. Setup](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/1-SETUP.md) â†’ [2. Main Application](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/2-MAINAPPLICATION.md) â†’ [3. Process Flow](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/3-PROCESS-FLOW.md) â†’ [4. Troubleshooting](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/4-ERRORS.md) â†’ [5. Scenarios](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/5-SCENARIOS.md) â†’ [6. ESP firmware](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/6-ESP-PLATFORMIO.md)  
> ðŸ‡­ðŸ‡º Magyar Ã¶sszefoglalÃ³k: [1. Setup](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/1-Setup-HU.md) â†’ [2. MainApplicationUI](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/2-MainApplication-HU.md) â†’ [3. Folyamat Ã¶sszefoglalÃ³](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/3-Process-Flow-HU.md) â†’ [4. HibakeresÃ©s](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/4-Errors-HU.md) â†’ [5. ForgatÃ³kÃ¶nyvek](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/5-Scenarios-HU.md) â†’ [6. ESP firmware](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/6-ESP-PLATFORMIO-HU.md)

---

## FÅ‘ funkciÃ³k
- VonalkÃ³d olvasÃ¡s: kÃ¼lÃ¶n porton a Dashboard (ACM0) Ã©s a Setup (ACM1).
- ESP kommunikÃ¡ciÃ³: CHECK/MONITOR Ã©s ESP programozÃ¡s automatikus visszajelzÃ©ssel.
- Redis integrÃ¡ciÃ³: aliasok, pinek, KSK lockok Ã©s Krosy checkpoint tÃ¡rolÃ¡sa.
- Krosy XML feldolgozÃ¡s: Setup oldalon pin â†’ alias megfeleltetÃ©s Ã©s opcionÃ¡lis checkpoint.
- Teljesen kliensmentes Ã¡llapotkezelÃ©s (nincs localStorage).

## Gyors indulÃ¡s
1. TelepÃ­tsd a fÃ¼ggÅ‘sÃ©geket: `npm install`
2. IndÃ­ts Redis-t (`npm run redis:up` vagy kÃ¼lsÅ‘ szerver).
3. `npm run dev` â€“ Next.js + Node szerver + Electron egyÃ¼tt indul.
4. Setup: `http://localhost:3000/setup` Â· Dashboard: `http://localhost:3000/`

### Hasznos parancsok
- `npm run predev` â€“ Redis kontÃ©ner felhÃºzÃ¡sa Ã©s readiness vÃ¡rakozÃ¡s
- `npm run dev` â€“ teljes fejlesztÅ‘i stack
- `npm run build` â€“ AppImage build (x86_64)
- `npm run build:arm64` â€“ AppImage ARM64
- `npm run lint` Â· `npm run type-check` â€“ kÃ³dellenÅ‘rzÃ©s

## Contributor Onboarding
Ãšj fejlesztÅ‘knek ajÃ¡nlott Ã¡ttekinteni a [AGENTS.md](./AGENTS.md) "Repository Guidelines" dokumentumot.
Ã–sszefoglalja a kÃ¶nyvtÃ¡rstruktÃºrÃ¡t, fÅ‘ parancsokat, kÃ³dstÃ­lust Ã©s PR elvÃ¡rÃ¡sokat, Ã­gy gyorsÃ­tja a belÃ©pÃ©st Ã©s az ellenÅ‘rzÃ©si folyamatot.

## MainApplicationUI Scan Scenarios

```mermaid
flowchart LR
    A[IDLE: Scan Prompt] -->|Scan or Run Check| B{Setup data present?}
    B -- No --> B1[No setup data for this MAC<br/>Clear scanned code<br/>Briefly block retries] --> A

    B -- Yes --> C{Any failures or unknown pins?}
    C -- Yes --> D[Enter LIVE MODE]
    C -- No --> E[Finalize live suppressed]
    E --> E1[Send checkpoints]
    E1 --> E2[Clear Redis alias cache and KSK locks]
    E2 --> E3[Flash OK SVG]
    E3 --> A

    %% Error path
    A -.->|Errors 429 504 Pending during scan| F[Auto-Retry Loop]
    F -->|Retry success| C
    F -->|Retries exhausted| G[Reset KFB context<br/>Clear branch data<br/>Prompt another attempt] --> A
```

1. INPUT: Scan or run check for a MAC/KFB without any setup aliases/pins -> OUTPUT: UI shows `No setup data available for this MAC`, clears the scanned code, blocks retries briefly, and idles.
2. INPUT: Scan or run check returns failures/unknown pin data -> OUTPUT: Live mode stays active, showing contact label names and pin statuses so the operator can inspect issues in real time.
2.1 INPUT: BranchDashboardMainContent enters live mode with active MAC -> OUTPUT: Renders status pill (`SCANNING`/`CHECKING`), builds branch cards with OK/NOK/Not Tested badges, highlights pending failures list, flashes large OK SVG when all pins recover, pushes checkpoints for the active KSKs, bulk-deletes the Redis alias cache entries for that MAC, clears the KSK locks, then returns to the scan prompt idle view.
3. INPUT: Scan or run check finishes with no failures and setup data present -> OUTPUT: Live mode is suppressed, finalize sends checkpoints for the active KSKs, clears the Redis alias cache and KSK locks, flashes the OK SVG confirmation, and then resets the UI for the next device.
4. INPUT: Scan or run check hits errors like 429/504/pending -> OUTPUT: Flow retries automatically; after retries are exhausted it resets the KFB context, clears branch data, and prompts another attempt.

### LIVE Mode Internals (Scenario 2.1)

```mermaid
flowchart TB
    L0[Live mode enter with active MAC] --> L1[Render status pill SCANNING or CHECKING]
    L1 --> L2[Build branch cards with OK or NOK or Not Tested]
    L2 --> L3[Show contact label names and pin states]
    L3 --> L4[Highlight pending failures list]
    L4 -->|All pins recover| L5[Flash large OK SVG]
    L5 --> L6[Push checkpoints for active KSKs]
    L6 --> L7[Bulk delete Redis alias cache for MAC]
    L7 --> L8[Clear KSK locks]
    L8 --> L9[Return to scan prompt IDLE]
```

### Error and Retry Handling (Scenario 4)

```mermaid
flowchart TB
    R0[Scan or run check] --> R1{Result}
    R1 -- 429 or 504 or Pending --> R2[Backoff and auto retry]
    R2 -->|Retry OK| R3[Continue normal flow<br/>Live mode or finalize]
    R2 -->|Retry exhausted| R4[Reset KFB context<br/>Clear branch data]
    R4 --> R5[Prompt user for another attempt] --> R6[IDLE]
```

## Kulcs kÃ¶rnyezeti vÃ¡ltozÃ³k (rÃ©szletek a doksiban)

| TÃ©ma | PÃ©lda vÃ¡ltozÃ³k | RÃ©szletes leÃ­rÃ¡s |
|------|----------------|------------------|
| **ESP** | `ESP_TTY_PATH`, `ESP_BAUD`, `ESP_HEALTH_PROBE`, `ESP_PING_CMD` | [EN](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/2-MAINAPPLICATION.md) Â· [HU](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/2-MainApplication-HU.md) |
| **Scannerek** | `SCANNER_TTY_PATHS`, `NEXT_PUBLIC_SCANNER_INDEX_DASHBOARD`, `NEXT_PUBLIC_SCANNER_INDEX_SETUP` | [EN](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/2-MAINAPPLICATION.md) Â· [HU](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/2-MainApplication-HU.md) |
| **Setup/Krosy** | `NEXT_PUBLIC_KROSY_ONLINE`, `NEXT_PUBLIC_KROSY_URL_ONLINE`, `NEXT_PUBLIC_KSK_TTL_SEC` | [EN](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/1-SETUP.md) Â· [HU](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/1-Setup-HU.md) |
| **Redis / Lockok** | `REDIS_URL`, `KSK_REQUIRE_REDIS`, `KSK_DEFAULT_TTL_SEC`, `NEXT_PUBLIC_KSK_REQUIRE_REDIS` | [EN](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/1-SETUP.md) |
| **Workflow** | `CHECK_SEND_MODE`, `NEXT_PUBLIC_SCANNER_POLL_IF_STALE_MS`, `NEXT_PUBLIC_FINALIZED_RESCAN_BLOCK_MS` | [EN](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/3-PROCESS-FLOW.md) |
| **NaplÃ³zÃ¡s** | `LOG_VERBOSE`, `LOG_ENABLE`, `LOG_TAG_LEVELS`, `LOG_MONITOR_ONLY` | [EN](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/4-ERRORS.md) |
| **ESP firmware** | `ESPNOW_CHANNEL`, MCP cÃ­mek, debounce konstansok | [EN](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/6-ESP-PLATFORMIO.md) Â· [HU](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/6-ESP-PLATFORMIO-HU.md) |

## AjÃ¡nlott olvasÃ¡si sorrend

1. **Setup / ElÅ‘kÃ©szÃ­tÃ©s**  
   - ðŸ‡¬ðŸ‡§ [docs/EN/1-SETUP.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/1-SETUP.md)  
   - ðŸ‡­ðŸ‡º [docs/HU/1-Setup-HU.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/1-Setup-HU.md)
2. **Main Application / Dashboard**  
   - ðŸ‡¬ðŸ‡§ [docs/EN/2-MAINAPPLICATION.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/2-MAINAPPLICATION.md)  
   - ðŸ‡­ðŸ‡º [docs/HU/2-MainApplication-HU.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/2-MainApplication-HU.md)
3. **Teljes folyamat leÃ­rÃ¡sa**  
   - ðŸ‡¬ðŸ‡§ [docs/EN/3-PROCESS-FLOW.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/3-PROCESS-FLOW.md)  
   - ðŸ‡­ðŸ‡º [docs/HU/3-Process-Flow-HU.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/3-Process-Flow-HU.md)
4. **HibakeresÃ©s**  
   - ðŸ‡¬ðŸ‡§ [docs/EN/4-ERRORS.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/4-ERRORS.md)  
   - ðŸ‡­ðŸ‡º [docs/HU/4-Errors-HU.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/4-Errors-HU.md)
5. **TovÃ¡bbi forgatÃ³kÃ¶nyvek / javaslatok**  
   - ðŸ‡¬ðŸ‡§ [docs/EN/5-SCENARIOS.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/5-SCENARIOS.md)  
   - ðŸ‡­ðŸ‡º [docs/HU/5-Scenarios-HU.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/5-Scenarios-HU.md)
6. **ESP firmware (PlatformIO projektek)**  
   - ðŸ‡¬ðŸ‡§ [docs/EN/6-ESP-PLATFORMIO.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/6-ESP-PLATFORMIO.md)  
   - ðŸ‡­ðŸ‡º [docs/HU/6-ESP-PLATFORMIO-HU.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/HU/6-ESP-PLATFORMIO-HU.md)

## NaplÃ³zÃ¡s Ã©s ellenÅ‘rzÃ©s
- `LOG_VERBOSE=1` â†’ fÃ¡jl naplÃ³k (`logs/app.log`, `.krosy-logs/...`).
- HibÃ¡k mindig bekerÃ¼lnek a `logs/errors.log` fÃ¡jlba.
- Konzol Ã¼zenetek: `MONITOR start/ok`, `CHECK fail`, Redis figyelmeztetÃ©sek.

## Gyakori hibÃ¡k
- **Nem indul a scan**: ellenÅ‘rizd a scanner portot az SSE streamben (`/api/serial/events`).
- **CHECK timeout**: vizsgÃ¡ld meg az ESP kÃ¡belt, `ESP_TTY_PATH` Ã©rtÃ©ket, prÃ³bÃ¡ld `ESP_DEBUG=1`-gyel.
- **Lock beragad**: `DELETE /api/ksk-lock?mac=...&force=1`, majd frissÃ­tsd a Setup oldalt.
- **Alias hiÃ¡nyzik**: futtasd `POST /api/aliases/rehydrate`, ellenÅ‘rizd `GET /api/aliases?mac=...&all=1` vÃ¡laszt.

---

## Projekt felÃ©pÃ­tÃ©se (rÃ¶viden)
- `src/app/` â€“ Next.js oldalak Ã©s API route-ok (App Router)
- `src/components/` â€“ UI komponensek (PascalCase)
- `src/lib/` â€“ osztott segÃ©dfÃ¼ggvÃ©nyek (serial, redis, logger)
- `main/` â€“ Electron fÅ‘folyamat
- `server.ts`, `dist-server/` â€“ Node szerver belÃ©pÃ©si pont + build
- `logs/` (pl. `app.log`, `errors.log`), `.krosy-logs/` â€“ naplÃ³k

## TÃ¡mogatÃ¡s
KÃ©rdÃ©s esetÃ©n nÃ©zd Ã¡t a [docs/EN/4-ERRORS.md](https://github.com/projects-kssk/Wireless_KFB_Project/blob/main/docs/EN/4-ERRORS.md) ÃºtmutatÃ³t, vagy jelezd a csapatnak a konkrÃ©t hibÃ¡t/naplÃ³ rÃ©szlettel.
Telefonos elÃ©rhetÅ‘sÃ©g: 621.
The project was made by Nagy Viktor.
